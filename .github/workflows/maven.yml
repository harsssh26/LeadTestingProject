name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # Step 3: Install Chrome and ChromeDriver
      - name: Install Chrome and ChromeDriver
        run: |
          echo "Installing the latest version of Google Chrome and ChromeDriver..."
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Detect Chrome version
          CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
          echo "Detected Chrome version: $CHROME_VERSION"
          
          # Find compatible ChromeDriver version
          DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
          if [ -z "$DRIVER_VERSION" ]; then
            DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE")
          fi
          echo "Detected ChromeDriver version: $DRIVER_VERSION"
          
          # Download and install ChromeDriver
          DRIVER_URL="https://chromedriver.storage.googleapis.com/$DRIVER_VERSION/chromedriver_linux64.zip"
          echo "Downloading ChromeDriver from: $DRIVER_URL"
          wget -q -O chromedriver.zip $DRIVER_URL
          unzip chromedriver.zip
          sudo mv chromedriver /usr/bin/
          chmod +x /usr/bin/chromedriver

      # Step 4: Debugging the environment
      - name: Debug Environment
        run: |
          echo "Checking Chrome and ChromeDriver versions..."
          google-chrome --version
          chromedriver --version
          java -version

      # Step 5: Run Maven tests
      - name: Build and Test with Maven
        run: mvn clean test
        env:
          DISPLAY: ":99.0" # To support headless mode if needed

      # Step 6: Cache Selenium drivers (optional)
      - name: Cache Selenium Drivers
        uses: actions/cache@v3
        with:
          path: ~/.cache/selenium
          key: ${{ runner.os }}-selenium

      # Step 7: Update dependency graph for Dependabot
      - name: Update dependency graph
        uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6
